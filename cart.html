<!--Project Name : StrathCart
  Team Members:
  - Sean Jalemba - 218821
  - Samuel Kimani - 220237 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StrathCart - Your Cart</title>
  <link rel="stylesheet" href="cartstyle.css">
  <link rel="stylesheet" href="responsive.css">
</head>
<body>

  <nav class="navbar">
    <div class="nav-content container">
      <img src="assets/logo.png" alt="StrathCart Logo" class="logo">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="menu.html">Menu</a></li>
        <li><a href="orders.html">My Orders</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="contact.html">Contact Us</a></li>
        <li><a href="account.html">Account</a></li>
        <li><a href="cart.html" class="active">Your Cart</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="cart-header">
      <h1>Shopping Cart</h1>
      <p id="cart-item-count">Loading cart...</p>
    </div>

    <div class="cart-container">
      <div class="cart-items" id="cart-items">
        <div style="text-align: center; padding: 3rem;">
          <p>Loading your cart...</p>
        </div>
      </div>

      <div class="cart-summary" id="cart-summary" style="display: none;">
        <h2>Order Summary</h2>
        <div class="summary-row">
          <span>Total Items:</span>
          <span id="summary-item-count">0</span>
        </div>
        <div class="summary-row total">
          <span>Order Total:</span>
          <span id="total">KES 0.00</span>
        </div>
        <button class="checkout-btn" id="checkout-btn" onclick="proceedToCheckout()">Proceed to Checkout</button>
        <a href="menu.html" class="continue-shopping">Continue Shopping</a>
      </div>
    </div>
  </div>

  <footer class="home-footer">
    <p>&copy; 2025 StrathCart. All rights reserved.</p>
  </footer>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS with your public key
    (function(){
      emailjs.init("_EAFuYn_2tA8LaBnV");
    })();
  </script>

  <!-- Firebase & Cart JS -->
  <script type="module">
    import { auth, db } from './config.js';
    import { 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      doc, 
      getDoc, 
      setDoc, 
      deleteDoc, 
      collection, 
      addDoc,
      Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let cartData = { items: [] };
    let currentUser = null;
    let userData = null;

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      
      // Get user data from Firestore (try both "users" and "Users" collections)
      try {
        let userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists()) {
          userDoc = await getDoc(doc(db, "Users", user.uid));
        }
        if (userDoc.exists()) {
          userData = userDoc.data();
          console.log('User data loaded:', userData);
        } else {
          console.warn('User document not found in Firestore');
        }
      } catch (error) {
        console.error("Error loading user data:", error);
      }

      loadCart();
    });

    async function loadCart() {
      if (!currentUser) return;

      try {
        const cartRef = doc(db, "Cart", currentUser.uid);
        const cartSnap = await getDoc(cartRef);

        if (cartSnap.exists()) {
          const data = cartSnap.data();
          cartData.items = Array.isArray(data.items) ? data.items : [];

          // Normalize items
          cartData.items = cartData.items.map(item => ({
            itemID: item.itemID || item.id || 'unknown',
            itemname: item.itemname || 'Unknown Item',
            price: parseFloat(item.price) || 0,
            quantity: parseInt(item.quantity) || 1,
            imageurl: item.imageurl || 'assets/logo.png'
          }));

          if (cartData.items.length > 0) {
            renderCart();
            updateSummary();
          } else {
            showEmptyCart();
          }
        } else {
          showEmptyCart();
        }
      } catch (error) {
        console.error("Error loading cart:", error);
        showEmptyCart();
      }
    }

    function renderCart() {
      const cartItemsContainer = document.getElementById('cart-items');
      cartItemsContainer.innerHTML = '';

      if (!cartData.items || cartData.items.length === 0) {
        showEmptyCart();
        return;
      }

      cartData.items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.setAttribute('data-item-id', item.itemID);

        div.innerHTML = `
          <img src="${item.imageurl}" alt="${item.itemname}" class="cart-item-image" onerror="this.src='assets/logo.png'">
          <div class="cart-item-details">
            <h3>${item.itemname}</h3>
            <p>KES ${item.price.toFixed(2)} each</p>
            <div class="cart-item-actions">
              <button onclick="decreaseQuantity('${item.itemID}')">-</button>
              <input type="text" id="qty-${item.itemID}" value="${item.quantity}" readonly>
              <button onclick="increaseQuantity('${item.itemID}')">+</button>
              <button onclick="removeItem('${item.itemID}')" style="margin-left: 1rem; background: #ef4444;">Remove</button>
            </div>
          </div>
          <div class="cart-item-price" id="price-${item.itemID}">
            KES ${(item.price * item.quantity).toFixed(2)}
          </div>
        `;

        cartItemsContainer.appendChild(div);
      });

      document.getElementById('cart-summary').style.display = 'block';
    }

    function updateSummary() {
      const totalItems = cartData.items.reduce((sum, item) => sum + item.quantity, 0);
      const total = cartData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      document.getElementById('cart-item-count').textContent = 
        `${cartData.items.length} item${cartData.items.length !== 1 ? 's' : ''} in your cart`;
      document.getElementById('summary-item-count').textContent = totalItems;
      document.getElementById('total').textContent = `KES ${total.toFixed(2)}`;
    }

    async function saveCart() {
      if (!currentUser) return;

      try {
        const cartRef = doc(db, "Cart", currentUser.uid);
        if (cartData.items.length === 0) {
          await deleteDoc(cartRef);
        } else {
          await setDoc(cartRef, {
            userId: currentUser.uid,
            items: cartData.items,
            updatedAt: Timestamp.now()
          });
        }
      } catch (error) {
        console.error("Error saving cart:", error);
      }
    }

    window.increaseQuantity = async function(itemID) {
      const item = cartData.items.find(i => i.itemID === itemID);
      if (!item) return;

      item.quantity++;
      document.getElementById(`qty-${itemID}`).value = item.quantity;
      document.getElementById(`price-${itemID}`).textContent = 
        `KES ${(item.price * item.quantity).toFixed(2)}`;
      updateSummary();
      await saveCart();
    };

    window.decreaseQuantity = async function(itemID) {
      const item = cartData.items.find(i => i.itemID === itemID);
      if (!item) return;

      if (item.quantity > 1) {
        item.quantity--;
        document.getElementById(`qty-${itemID}`).value = item.quantity;
        document.getElementById(`price-${itemID}`).textContent = 
          `KES ${(item.price * item.quantity).toFixed(2)}`;
        updateSummary();
        await saveCart();
      } else {
        await removeItem(itemID);
      }
    };

    window.removeItem = async function(itemID) {
      if (!confirm('Remove this item from your cart?')) return;

      cartData.items = cartData.items.filter(i => i.itemID !== itemID);
      const el = document.querySelector(`[data-item-id="${itemID}"]`);
      if (el) el.remove();

      if (cartData.items.length === 0) {
        showEmptyCart();
      } else {
        updateSummary();
      }
      await saveCart();
    };

    function showEmptyCart() {
      document.getElementById('cart-items').innerHTML = `
        <div style="text-align: center; padding: 3rem;">
          <h2>Your cart is empty</h2>
          <p style="margin: 1rem 0; color: #A8B2C1;">Add items to your cart to proceed with ordering.</p>
          <a href="menu.html" class="btn-primary">Browse Menu</a>
        </div>
      `;
      document.getElementById('cart-summary').style.display = 'none';
      document.getElementById('cart-item-count').textContent = '0 items in your cart';
    }

    // Proceed to checkout with EmailJS
    window.proceedToCheckout = async function() {
      if (!currentUser || cartData.items.length === 0) {
        alert('Cart is empty or user data not loaded.');
        return;
      }

      const checkoutBtn = document.getElementById('checkout-btn');
      checkoutBtn.disabled = true;
      checkoutBtn.textContent = 'Processing...';

      const total = cartData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const orderNumber = `ORD-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(Math.random() * 1000)}`;
      
      const orderTime = new Date();
      const collectionTime = new Date(orderTime.getTime() + 60 * 60 * 1000); // +1 hour

      const orderData = {
        orderNumber: orderNumber,
        orderID: Math.floor(1000 + Math.random() * 9000),
        userId: currentUser.uid,
        admissionNumber: userData?.admissionNumber || 'N/A',
        email: currentUser.email,
        items: cartData.items.map(item => ({
          itemID: item.itemID,
          itemname: item.itemname,
          price: parseFloat(item.price),
          quantity: parseInt(item.quantity),
          subtotal: parseFloat(item.price) * parseInt(item.quantity)
        })),
        Total: parseFloat(total),
        Status: 'pending',
        ordercreated: Timestamp.fromDate(orderTime),
        collectiontime: Timestamp.fromDate(collectionTime)
      };

      const confirmed = confirm(
        `Order Summary:\n\n` +
        `Items: ${cartData.items.length}\n` +
        `Total: KES ${total.toFixed(2)}\n` +
        `Collection Time: ${collectionTime.toLocaleString()}\n\n` +
        `Confirm order?`
      );

      if (!confirmed) {
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Proceed to Checkout';
        return;
      }

      try {
        // 1. Save order to Firestore
        await addDoc(collection(db, "Orders"), orderData);
        console.log('Order saved to Firestore');

        // 2. Prepare email items list
        const itemsList = cartData.items.map(item => 
          `${item.itemname} x${item.quantity} - KES ${(item.price * item.quantity).toFixed(2)}`
        ).join('\n');

        // 3. Send email via EmailJS
        const emailParams = {
          user_name: userData?.fullName || userData?.name || 'Customer',
          user_email: currentUser.email, // Make sure this matches your EmailJS template variable
          order_number: orderNumber,
          order_items: itemsList,
          order_total: total.toFixed(2),
          collection_time: collectionTime.toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })
        };

        console.log('Sending email with params:', emailParams);
        console.log('Recipient email:', currentUser.email);

        // Send email with explicit recipient
        await emailjs.send(
          'service_yuralkh', 
          'template_3mspdgl', 
          emailParams,
          '_EAFuYn_2tA8LaBnV' // Your public key
        );
        console.log('Email sent successfully');

        // 4. Clear cart
        await deleteDoc(doc(db, "Cart", currentUser.uid));
        cartData.items = [];

        alert(
          `Order placed successfully!\n\n` +
          `Order Number: ${orderNumber}\n` +
          `Collection Time: ${collectionTime.toLocaleString()}\n\n` +
          `A confirmation email has been sent to ${currentUser.email}`
        );
        
        window.location.href = 'orders.html';

      } catch (error) {
        console.error('Checkout error:', error);
        alert('Failed to place order. Please try again.\n\nError: ' + error.message);
        
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Proceed to Checkout';
      }
    };
  </script>

</body>
</html>