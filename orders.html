<!--Project Name : StrathCart
  Team Members:
  - Sean Jalemba - 218821
  - Samuel Kimani - 220237 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StrathCart - My Orders</title>
  <link rel="stylesheet" href="orders.css" />
  <link rel="stylesheet" href="responsive.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-content container">
      <img src="assets/logo.png" alt="StrathCart Logo" class="logo" />
      <ul class="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="menu.html">Menu</a></li>
        <li><a href="orders.html" class="active">My Orders</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="contact.html">Contact Us</a></li>
        <li><a href="account.html">Account</a></li>
        <li class="cart-link">
          <a href="cart.html">Your Cart</a>
          <span class="cart-badge" id="cart-badge">0</span>
        </li>
      </ul>
    </div>
  </nav>

  <section class="orders-section container">
    <h2>My Orders</h2>
    <div class="order-filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="pending">Pending</button>
      <button class="filter-btn" data-filter="preparing">Preparing</button>
      <button class="filter-btn" data-filter="ready">Ready</button>
      <button class="filter-btn" data-filter="completed">Completed</button>
      <button class="filter-btn" data-filter="cancelled">Cancelled</button>
    </div>

    <div id="orders-list" class="orders-list">
      <div style="text-align: center; padding: 3rem;">
        <p>Loading your orders...</p>
      </div>
    </div>
  </section>

  <footer class="menu-footer">
    <p>&copy; 2025 StrathCart. All rights reserved.</p>
  </footer>

  <script type="module">
    import { auth, db } from './config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      collection,
      query,
      where,
      orderBy,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentUser = null;
    let allOrders = [];
    let currentFilter = 'all';

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        loadOrders();
        updateCartBadge();
      } else {
        window.location.href = 'login.html';
      }
    });

    async function loadOrders() {
      try {
        if (!currentUser) return;
        
        const ordersRef = collection(db, "Orders");
        const q = query(
          ordersRef,
          where("userId", "==", currentUser.uid),
          orderBy("ordercreated", "desc")
        );
        
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          showEmptyOrders();
          return;
        }

        allOrders = [];
        querySnapshot.forEach((docSnap) => {
          allOrders.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });

        renderOrders();
        
      } catch (error) {
        console.error("Error loading orders:", error);
        document.getElementById('orders-list').innerHTML = `
          <div class="empty-message">
            <h3>Error Loading Orders</h3>
            <p>${error.message}</p>
            <button onclick="location.reload()" class="btn-primary">Refresh Page</button>
          </div>
        `;
      }
    }

    function renderOrders() {
      const ordersContainer = document.getElementById('orders-list');
      ordersContainer.innerHTML = '';

      let filteredOrders = allOrders;
      if (currentFilter !== 'all') {
        filteredOrders = allOrders.filter(order => 
          order.Status.toLowerCase() === currentFilter.toLowerCase()
        );
      }

      if (filteredOrders.length === 0) {
        ordersContainer.innerHTML = `
          <div class="empty-message">
            <h3>No ${currentFilter !== 'all' ? currentFilter : ''} orders found</h3>
            <p>You don't have any ${currentFilter !== 'all' ? currentFilter + ' ' : ''}orders yet.</p>
            <a href="menu.html">Browse Menu</a>
          </div>
        `;
        return;
      }

      filteredOrders.forEach(order => {
        const orderCard = createOrderCard(order);
        ordersContainer.appendChild(orderCard);
      });
    }

    function createOrderCard(order) {
      const orderDiv = document.createElement('div');
      orderDiv.className = 'order-card';
      
      const orderDate = order.ordercreated?.toDate ? 
        order.ordercreated.toDate() : 
        new Date(order.ordercreated);
      
      const collectionTime = order.collectiontime?.toDate ? 
        order.collectiontime.toDate() : 
        new Date(order.collectiontime);

      const orderDateStr = orderDate.toLocaleString('en-KE', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const collectionTimeStr = collectionTime.toLocaleString('en-KE', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const statusInfo = getStatusInfo(order.Status);
      const total = Number(order.Total) || 0;

      let itemsHTML = '';
      if (order.items && Array.isArray(order.items) && order.items.length > 0) {
        itemsHTML = order.items.map(item => {
          const itemPrice = Number(item.price) || 0;
          const itemQty = Number(item.quantity) || 1;
          return `
            <div class="order-item">
              <h4>${item.itemname || 'Unknown Item'}</h4>
              <p style="color: #A8B2C1;">Qty: ${itemQty} Ã— KES ${itemPrice.toFixed(2)} = KES ${(itemPrice * itemQty).toFixed(2)}</p>
            </div>
          `;
        }).join('');
      } else {
        itemsHTML = '<div class="order-item"><p style="color: #A8B2C1;">No item details available</p></div>';
      }

      orderDiv.innerHTML = `
        <div class="order-header">
          <div class="order-info">
            <h3>Order #${order.orderNumber || order.orderID}</h3>
            <p style="color: #A8B2C1; margin: 0.25rem 0;">Placed on ${orderDateStr}</p>
          </div>
          <span class="order-status ${statusInfo.class}">${statusInfo.text}</span>
        </div>

        <div class="order-body">
          ${itemsHTML}
          
          <div class="order-details">
            <p><strong>Collection Time:</strong> ${collectionTimeStr}</p>
            <p><strong>Email:</strong> ${order.email}</p>
            ${order.admissionNumber ? `<p><strong>Admission No:</strong> ${order.admissionNumber}</p>` : ''}
          </div>
        </div>

        <div class="order-footer">
          <div class="order-total">
            <span style="color: #A8B2C1;">Total:</span>
            <span class="total-amount">KES ${total.toFixed(2)}</span>
          </div>
          <div class="order-actions">
            ${getOrderActions(order)}
          </div>
        </div>
      `;

      return orderDiv;
    }

    function getStatusInfo(status) {
      const statusLower = status.toLowerCase();
      
      const statusMap = {
        'pending': { class: 'status-pending', text: 'Pending' },
        'preparing': { class: 'status-preparing', text: 'Preparing' },
        'ready': { class: 'status-ready', text: 'Ready for Collection' },
        'completed': { class: 'status-completed', text: 'Completed' },
        'cancelled': { class: 'status-cancelled', text: 'Cancelled' }
      };

      return statusMap[statusLower] || { class: 'status-pending', text: status };
    }

    function getOrderActions(order) {
      const status = order.Status.toLowerCase();
      
      if (status === 'pending') {
        return `
          <button class="btn-cancel" onclick="cancelOrder('${order.id}')">Cancel Order</button>
        `;
      } else if (status === 'ready') {
        return `
          <button class="btn-primary" onclick="markAsCollected('${order.id}')">Mark as Collected</button>
        `;
      } else if (status === 'completed') {
        return `
          <button class="btn-reorder" onclick="reorder('${order.id}')">Reorder</button>
        `;
      }
      
      return '';
    }

    function showEmptyOrders() {
      document.getElementById('orders-list').innerHTML = `
        <div class="empty-message">
          <h3>No orders yet</h3>
          <p>You haven't placed any orders. Start browsing our menu!</p>
          <a href="menu.html">Browse Menu</a>
        </div>
      `;
    }

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.getAttribute('data-filter');
        renderOrders();
      });
    });

    // Cancel Order
    window.cancelOrder = async function(orderId) {
      if (!confirm('Are you sure you want to cancel this order?')) return;
      
      try {
        await updateDoc(doc(db, "Orders", orderId), {
          Status: 'cancelled'
        });
        
        alert('Order cancelled successfully!');
        await loadOrders();
        
      } catch (error) {
        console.error('Error cancelling order:', error);
        alert('Failed to cancel order. Please try again.');
      }
    };

    // Mark as Collected
    window.markAsCollected = async function(orderId) {
      if (!confirm('Confirm that you have collected this order?')) return;
      
      try {
        await updateDoc(doc(db, "Orders", orderId), {
          Status: 'completed'
        });
        
        alert('Order marked as collected!');
        await loadOrders();
        
      } catch (error) {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
      }
    };

    // Reorder functionality
    window.reorder = async function(orderId) {
      try {
        const order = allOrders.find(o => o.id === orderId);
        if (!order || !order.items || order.items.length === 0) {
          alert('Cannot reorder: Order items not found');
          return;
        }

        // Add items back to cart
        const cartRef = doc(db, "Cart", currentUser.uid);
        const cartSnap = await getDoc(cartRef);

        let cartData;
        if (cartSnap.exists()) {
          cartData = cartSnap.data();
        } else {
          cartData = { userId: currentUser.uid, items: [] };
        }

        // Add order items to cart
        order.items.forEach(orderItem => {
          const existingItem = cartData.items.find(item => item.itemID === orderItem.itemID);
          
          if (existingItem) {
            existingItem.quantity += orderItem.quantity;
          } else {
            cartData.items.push({
              itemID: orderItem.itemID,
              itemname: orderItem.itemname,
              price: orderItem.price,
              quantity: orderItem.quantity,
              imageurl: orderItem.imageurl || 'assets/logo.png'
            });
          }
        });

        await updateDoc(cartRef, cartData);
        
        alert(`${order.items.length} item(s) added to your cart!`);
        window.location.href = 'cart.html';
        
      } catch (error) {
        console.error('Error reordering:', error);
        alert('Failed to reorder. Please try again.');
      }
    };

    // Update cart badge
    async function updateCartBadge() {
      if (!currentUser) return;

      try {
        const cartRef = doc(db, "Cart", currentUser.uid);
        const cartSnap = await getDoc(cartRef);
        
        const badge = document.getElementById('cart-badge');
        
        if (cartSnap.exists()) {
          const cartData = cartSnap.data();
          const count = cartData.items.reduce((total, item) => total + item.quantity, 0);
          badge.textContent = count;
          badge.style.display = count > 0 ? 'flex' : 'none';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error("Error updating badge:", error);
      }
    }
  </script>
</body>
</html>