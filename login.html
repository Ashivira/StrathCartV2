<!--Project Name : StrathCart
  Team Members:
  - Sean Jalemba - 218821
  - Samuel Kimani - 220237 -->

  <!--initial start 3/10/2025-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - StrathCart</title>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/douictwnx/image/upload/v1764699863/logo_qc6fzp.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="responsive.css">
</head>
<body class="auth-body">

  <div class="auth-container glass-effect">
    <img src="assets/logo.png" alt="StrathCart Logo" class="auth-logo">
    <h2>Login to StrathCart</h2>
    
    <form id="loginForm">
      <input type="email" id="email" placeholder="name@strathmore.edu" required>
      <input type="password" id="password" placeholder="Password" required>
      <div id="error-message" style="color: #ef4444; font-size: 0.85rem; margin: 0.5rem 0; display: none;"></div>
      <button type="submit" class="btn-login">Login</button>
    </form>

    <p class="signup-text">Don't have an account? 
      <a href="setup.html" class="signup-link">Sign Up</a>
    </p>
    <p class="admin-link">
      Admin? <a href="admin/adminlogin.html">Log in here</a>
    </p>
  </div>

  <footer>
    <p>Â© StrathCart 2025. All Rights Reserved.</p>
  </footer>

  <script type="module">
  import { auth, db } from "./config.js"; 
  import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const loginForm = document.getElementById('loginForm');
  const errorMessage = document.getElementById('error-message');

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    errorMessage.style.display = 'none';

    if (!email.endsWith('@strathmore.edu')&& !email.endsWith('@gmail.com'))  {
      errorMessage.textContent = 'Please use your Strathmore University email';
      errorMessage.style.display = 'block';
      return;
    }

    const submitBtn = loginForm.querySelector('.btn-login');
    submitBtn.textContent = 'Logging in...';
    submitBtn.disabled = true;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Now db will work properly!
      const userDoc = await getDoc(doc(db, "Users", user.uid));  // Note: Check collection name
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        
        await updateDoc(doc(db, "Users", user.uid), {
          lastLogin: new Date()
        });

        sessionStorage.setItem('strathcart_user', JSON.stringify({
          uid: user.uid,
          email: user.email,
          admissionNumber: userData.admissionNumber,
          fullName: userData.fullName,
          role: userData.role
        }));

        if (userData.role === 'admin' || userData.role === 'staff') {
          window.location.href = 'admin/dashboard.html';
        } else {
          window.location.href = 'home.html';
        }
      } else {
        errorMessage.textContent = 'User profile not found';
        errorMessage.style.display = 'block';
        submitBtn.textContent = 'Login';
        submitBtn.disabled = false;
      }
    } catch (error) {
      console.error('Login error:', error);
      errorMessage.textContent = error.code === 'auth/invalid-credential' 
        ? 'Invalid email or password' 
        : 'Login failed. Please try again';
      errorMessage.style.display = 'block';
      submitBtn.textContent = 'Login';
      submitBtn.disabled = false;
    }
  });
</script>
</body>
</html>
