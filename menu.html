<!--Project Name : StrathCart
  Team Members:
  - Sean Jalemba - 218821
  - Samuel Kimani - 220237 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StrathCart - Menu</title>
  <link rel="stylesheet" href="menu.css">
</head>
<body>

  <nav class="navbar">
    <div class="nav-content container">
      <img src="assets/logo.png" alt="StrathCart Logo" class="logo">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="menu.html" class="active">Menu</a></li>
        <li><a href="orders.html">My Orders</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="contact.html">Contact Us</a></li>
        <li><a href="account.html">Account</a></li>
        <li class="cart-link">
          <a href="cart.html">Your Cart</a>
          <span class="cart-badge" id="cart-badge">0</span>
        </li>
      </ul>
    </div>
  </nav>

  <section class="menu-section container">
    <h2>Today's Menu</h2>

    <!-- Search and Filter -->
    <div class="search-filter-container">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="Search for dishes..."
          oninput="filterMenu()"
        >
      </div>
      
      <div class="category-filters">
        <button class="category-btn active" data-category="all" onclick="filterByCategory('all')">All</button>
        <button class="category-btn" data-category="Main Course" onclick="filterByCategory('Main Course')">Main Course</button>
        <button class="category-btn" data-category="Vegetarian" onclick="filterByCategory('Vegetarian')">Vegetarian</button>
        <button class="category-btn" data-category="Fast Food" onclick="filterByCategory('Fast Food')">Fast Food</button>
        <button class="category-btn" data-category="Salads" onclick="filterByCategory('Salads')">Salads</button>
        <button class="category-btn" data-category="Beverages" onclick="filterByCategory('Beverages')">Beverages</button>
        <button class="category-btn" data-category="Desserts" onclick="filterByCategory('Desserts')">Desserts</button>
      </div>
    </div>

    <div class="results-info" id="results-info"></div>
    
    <div class="loading" id="loading">Loading menu items...</div>
    <div class="menu-list" id="menu-list" style="display: none;"></div>
  </section>

  <div class="toast" id="toast">
    <span>‚úì Item added to cart!</span>
  </div>

  <footer class="menu-footer">
    <p>&copy; 2025 StrathCart. All rights reserved.</p>
  </footer>

  <script type="module">
    import { auth, db } from './config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      collection, 
      getDocs, 
      query, 
      where, 
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentUser = null;
    let authReady = false;
    let allMenuItems = [];
    let currentCategory = 'all';

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      authReady = true;
      
      if (user) {
        updateCartBadge();
      }
    });

    async function loadMenuItems() {
      try {
        const menuRef = collection(db, "Menuitems");
        const querySnapshot = await getDocs(menuRef);
        
        const loading = document.getElementById('loading');
        const menuList = document.getElementById('menu-list');
        
        if (querySnapshot.empty) {
          loading.textContent = 'No menu items available at the moment.';
          return;
        }

        allMenuItems = [];
        querySnapshot.forEach((docSnap) => {
          allMenuItems.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });

        loading.style.display = 'none';
        menuList.style.display = 'grid';
        
        displayMenuItems(allMenuItems);
        
      } catch (error) {
        console.error("Error loading menu:", error);
        document.getElementById('loading').textContent = 'Error loading menu. Please refresh the page.';
      }
    }

    function displayMenuItems(items) {
      const menuList = document.getElementById('menu-list');
      menuList.innerHTML = '';

      if (items.length === 0) {
        menuList.innerHTML = '<div class="no-results">No items found matching your criteria.</div>';
        document.getElementById('results-info').textContent = 'No items found';
        return;
      }

      document.getElementById('results-info').textContent = `Showing ${items.length} item${items.length !== 1 ? 's' : ''}`;

      items.forEach(item => {
        const price = Number(item.price) || 0;
        const quantAvailable = Number(item.quantavailable) || 0;
        const itemName = item.itemname || 'Unknown Item';
        const description = item.description || 'No description available';
        const category = item.category || 'Uncategorized';
        const imageUrl = item.imageurl || 'assets/logo.png';
        const isAvailable = item.isavailable === true && quantAvailable > 0;
        
        const menuItemDiv = document.createElement('div');
        menuItemDiv.className = 'menu-item';
        menuItemDiv.setAttribute('data-item-id', item.id);
        menuItemDiv.setAttribute('data-category', category);
        menuItemDiv.setAttribute('data-name', itemName.toLowerCase());
        
        menuItemDiv.innerHTML = `
          <img src="${imageUrl}" alt="${itemName}" onerror="this.src='assets/logo.png'">
          <div class="menu-details">
            <span class="category-badge">${category}</span>
            <h3>${itemName}</h3>
            <p>${description}</p>
            <span class="availability ${!isAvailable ? 'out-of-stock' : ''}">
              ${isAvailable ? `In Stock (${quantAvailable} available)` : 'Out of Stock'}
            </span>
            <span class="price">KES ${price.toFixed(2)}</span>
            <button class="btn-secondary" onclick="addToCart('${item.id}')" ${!isAvailable ? 'disabled' : ''}>
              ${isAvailable ? 'Add to Cart' : 'Unavailable'}
            </button>
          </div>
        `;
        
        menuList.appendChild(menuItemDiv);
      });
    }

    window.filterByCategory = function(category) {
      currentCategory = category;
      
      // Update active button
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      filterMenu();
    };

    window.filterMenu = function() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      
      let filtered = allMenuItems;
      
      // Filter by category
      if (currentCategory !== 'all') {
        filtered = filtered.filter(item => item.category === currentCategory);
      }
      
      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(item => {
          const itemName = (item.itemname || '').toLowerCase();
          const description = (item.description || '').toLowerCase();
          return itemName.includes(searchTerm) || description.includes(searchTerm);
        });
      }
      
      displayMenuItems(filtered);
    };

    window.addToCart = async function(itemId) {
      try {
        if (!authReady) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        if (!currentUser) {
          alert('Please login to add items to cart');
          window.location.href = 'login.html';
          return;
        }

        const itemDoc = await getDoc(doc(db, "Menuitems", itemId));
        if (!itemDoc.exists()) {
          alert('Item not found');
          return;
        }

        const itemData = itemDoc.data();
        const price = Number(itemData.price) || 0;
        
        const cartRef = doc(db, "Cart", currentUser.uid);
        const cartSnap = await getDoc(cartRef);

        let cartData;
        if (cartSnap.exists()) {
          cartData = cartSnap.data();
          
          const existingItemIndex = cartData.items.findIndex(i => i.itemID === itemId);
          
          if (existingItemIndex >= 0) {
            cartData.items[existingItemIndex].quantity += 1;
          } else {
            cartData.items.push({
              itemID: itemId,
              itemname: itemData.itemname,
              price: price,
              quantity: 1,
              imageurl: itemData.imageurl
            });
          }
          cartData.updatedAt = new Date();
        } else {
          cartData = {
            userId: currentUser.uid,
            items: [{
              itemID: itemId,
              itemname: itemData.itemname,
              price: price,
              quantity: 1,
              imageurl: itemData.imageurl
            }],
            updatedAt: new Date()
          };
        }

        await setDoc(cartRef, cartData);
        
        showToast(`${itemData.itemname} added to cart!`);
        
        const button = document.querySelector(`[data-item-id="${itemId}"] .btn-secondary`);
        if (button) {
          button.textContent = '‚úì Added';
          button.classList.add('added');
          
          setTimeout(() => {
            button.textContent = 'Add to Cart';
            button.classList.remove('added');
          }, 1500);
        }
        
        updateCartBadge();
        
      } catch (error) {
        console.error("Error adding to cart:", error);
        alert('Failed to add item to cart. Please try again.');
      }
    };

    async function updateCartBadge() {
      if (!currentUser) return;

      try {
        const cartRef = doc(db, "Cart", currentUser.uid);
        const cartSnap = await getDoc(cartRef);
        
        const badge = document.getElementById('cart-badge');
        
        if (cartSnap.exists()) {
          const cartData = cartSnap.data();
          const count = cartData.items.reduce((total, item) => total + item.quantity, 0);
          badge.textContent = count;
          badge.style.display = count > 0 ? 'flex' : 'none';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error("Error updating badge:", error);
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      const span = toast.querySelector('span');
      if (span) {
        span.textContent = message;
      }
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    window.onload = function() {
      loadMenuItems();
    };
  </script>

</body>
</html>