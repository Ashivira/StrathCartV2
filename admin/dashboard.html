<!--Project Name : StrathCart
  Team Members:
  - Sean Jalemba - 218821
  - Samuel Kimani - 220237 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - StrathCart</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="../responsive.css">
</head>
<body>

  <nav class="navbar">
    <div class="nav-content container">
      <img src="../assets/logo.png" alt="StrathCart Logo" class="logo">
      <ul class="nav-links">
        <li><a href="#" class="active">Dashboard</a></li>
        <li><span id="admin-name" style="color: #58a4b0;">Admin</span></li>
        <li><button onclick="logout()" class="btn btn-secondary btn-small">Logout</button></li>
      </ul>
    </div>
  </nav>

  <main class="main-content container">
    <header class="admin-header">
      <h1>Admin Dashboard</h1>
      <p>Manage menu items, orders, and system users</p>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview')">Overview</button>
      <button class="tab" onclick="switchTab('menu')">Menu Items</button>
      <button class="tab" onclick="switchTab('orders')">Orders</button>
      <button class="tab" onclick="switchTab('users')">Create Admin</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
      <div class="dashboard-cards">
        <div class="stat-card"><h3>Total Sales</h3><div class="value" id="total-sales">KES 0</div></div>
        <div class="stat-card"><h3>Orders Today</h3><div class="value" id="orders-today">0</div></div>
        <div class="stat-card"><h3>Pending Orders</h3><div class="value" id="pending-orders">0</div></div>
        <div class="stat-card"><h3>Menu Items</h3><div class="value" id="menu-items-count">0</div></div>
      </div>

      <div class="table-container">
        <div class="table-header"><h2>Recent Orders</h2></div>
        <table>
          <thead><tr><th>Order ID</th><th>Student</th><th>Total</th><th>Status</th><th>Time</th></tr></thead>
          <tbody id="recent-orders-body"><tr><td colspan="5" class="loading">Loading orders...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Menu Items Tab -->
    <div id="menu-tab" class="tab-content">
      <button class="btn btn-primary" onclick="openMenuModal()">+ Add New Menu Item</button>
      <div class="table-container" style="margin-top: 1.5rem;">
        <table>
          <thead><tr><th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Available</th><th>Actions</th></tr></thead>
          <tbody id="menu-items-body"><tr><td colspan="7" class="loading">Loading menu items...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders-tab" class="tab-content">
      <div class="table-container">
        <div class="table-header">
          <h2>All Orders</h2>
          <select id="order-filter" onchange="filterOrders()">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="preparing">Preparing</option>
            <option value="ready">Ready</option>
            <option value="collected">Collected</option>
          </select>
        </div>
        <table>
          <thead><tr><th>Order #</th><th>Student</th><th>Items</th><th>Total</th><th>Status</th><th>Order Time</th><th>Collection Time</th><th>Actions</th></tr></thead>
          <tbody id="all-orders-body"><tr><td colspan="8" class="loading">Loading orders...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Admin Tab -->
    <div id="users-tab" class="tab-content">
      <div class="form-container">
        <h2 style="margin-bottom: 1.5rem;">Create New Admin Account</h2>
        <div class="form-group"><label>Full Name *</label><input type="text" id="admin-fullname" required></div>
        <div class="form-group"><label>Email (@strathmore.edu) *</label><input type="email" id="admin-email" required></div>
        <div class="form-group"><label>Admission Number *</label><input type="text" id="admin-admission" required></div>
        <div class="form-group"><label>Password *</label><input type="password" id="admin-password" required></div>
        <button onclick="createAdmin()" class="btn btn-primary">Create Admin Account</button>
      </div>
    </div>
  </main>

  <!-- Menu Item Modal -->
  <div id="menu-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Add Menu Item</h2>
        <button class="modal-close" onclick="closeMenuModal()">×</button>
      </div>
      <div class="form-group">
        <label>Item Image</label>
        <div class="image-upload" onclick="document.getElementById('item-image').click()">
          <p>Click to upload image</p>
          <img id="image-preview" class="image-preview" style="display: none;">
        </div>
        <input type="file" id="item-image" accept="image/*" style="display: none;" onchange="previewImage(this)">
      </div>
      <div class="form-group"><label>Item Name *</label><input type="text" id="item-name" required></div>
      <div class="form-group"><label>Description *</label><textarea id="item-description" required></textarea></div>
      <div class="form-group">
        <label>Category *</label>
        <select id="item-category" required>
          <option value="Main Course">Main Course</option>
          <option value="Vegetarian">Vegetarian</option>
          <option value="Fast Food">Fast Food</option>
          <option value="Salads">Salads</option>
          <option value="Beverages">Beverages</option>
          <option value="Desserts">Desserts</option>
        </select>
      </div>
      <div class="form-group"><label>Price (KES) *</label><input type="number" id="item-price" required min="0"></div>
      <div class="form-group"><label>Stock Quantity *</label><input type="number" id="item-quantity" required min="0"></div>
      <div class="form-group"><label><input type="checkbox" id="item-available" checked> Available for ordering</label></div>
      <button onclick="saveMenuItem()" class="btn btn-primary">Save Menu Item</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from '../config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let currentUser = null;
    let allOrders = [];
    let currentEditId = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'adminlogin.html';
      const userDoc = await getDoc(doc(db, "Users", user.uid));
      if (!userDoc.exists() || (userDoc.data().role !== 'admin' && userDoc.data().role !== 'staff')) {
        alert('Access denied. Admin privileges required.');
        return window.location.href = '../login.html';
      }
      currentUser = userDoc.data();
      document.getElementById('admin-name').textContent = currentUser.fullName;
      loadDashboardData();
    });

    async function loadDashboardData() {
      await Promise.all([loadStats(), loadRecentOrders(), loadMenuItems(), loadAllOrders()]);
    }

    // ------------------ STATS & ORDERS ------------------
    async function loadStats() {
      const ordersSnap = await getDocs(collection(db, "Orders"));
      const menuSnap = await getDocs(collection(db, "Menuitems"));
      let totalSales = 0, ordersToday = 0, pendingOrders = 0;
      const today = new Date().toDateString();
      ordersSnap.forEach(doc => {
        const order = doc.data();
        totalSales += order.Total || 0;
        if (order.Status === 'pending') pendingOrders++;
        if (order.ordercreated?.toDate().toDateString() === today) ordersToday++;
      });
      document.getElementById('total-sales').textContent = `KES ${totalSales.toLocaleString()}`;
      document.getElementById('orders-today').textContent = ordersToday;
      document.getElementById('pending-orders').textContent = pendingOrders;
      document.getElementById('menu-items-count').textContent = menuSnap.size;
    }

    async function loadRecentOrders() {
      const ordersSnap = await getDocs(query(collection(db, "Orders"), orderBy("ordercreated", "desc")));
      const tbody = document.getElementById('recent-orders-body');
      tbody.innerHTML = '';
      let count = 0;
      ordersSnap.forEach(docSnap => {
        if (count >= 10) return;
        const order = docSnap.data();
        tbody.innerHTML += `<tr>
          <td>#${order.orderID || docSnap.id.slice(-4)}</td>
          <td>${order.admissionNumber}</td>
          <td>KES ${order.Total}</td>
          <td><span class="status-badge status-${order.Status}">${order.Status}</span></td>
          <td>${order.ordercreated ? order.ordercreated.toDate().toLocaleString() : 'N/A'}</td>
        </tr>`;
        count++;
      });
      if (count === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No orders yet</td></tr>';
    }

    async function loadAllOrders() {
      const ordersSnap = await getDocs(query(collection(db, "Orders"), orderBy("ordercreated", "desc")));
      allOrders = [];
      ordersSnap.forEach(docSnap => allOrders.push({ id: docSnap.id, ...docSnap.data() }));
      displayOrders(allOrders);
    }

    function displayOrders(orders) {
      const tbody = document.getElementById('all-orders-body');
      tbody.innerHTML = orders.length === 0 ? '<tr><td colspan="8" style="text-align:center;">No orders found</td></tr>' : '';
      orders.forEach(order => {
        tbody.innerHTML += `<tr>
          <td>#${order.orderID || order.id.slice(-4)}</td>
          <td>${order.admissionNumber}<br><small>${order.email}</small></td>
          <td>${order.items?.length || 0} items</td>
          <td>KES ${order.Total}</td>
          <td><select onchange="updateOrderStatus('${order.id}', this.value)" class="status-badge status-${order.Status}">
            <option value="pending" ${order.Status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="preparing" ${order.Status === 'preparing' ? 'selected' : ''}>Preparing</option>
            <option value="ready" ${order.Status === 'ready' ? 'selected' : ''}>Ready</option>
            <option value="collected" ${order.Status === 'collected' ? 'selected' : ''}>Collected</option>
          </select></td>
          <td>${order.ordercreated ? order.ordercreated.toDate().toLocaleString() : 'N/A'}</td>
          <td>${order.collectiontime ? order.collectiontime.toDate().toLocaleString() : 'N/A'}</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteOrder('${order.id}')">Delete</button></td>
        </tr>`;
      });
    }

    window.filterOrders = () => {
      const filter = document.getElementById('order-filter').value;
      displayOrders(filter === 'all' ? allOrders : allOrders.filter(o => o.Status === filter));
    };

    window.updateOrderStatus = async (orderId, newStatus) => {
      await updateDoc(doc(db, "Orders", orderId), { Status: newStatus });
      alert('Order status updated!');
      loadStats();
      loadAllOrders();
    };

    window.deleteOrder = async (orderId) => {
      if (!confirm('Delete this order?')) return;
      await deleteDoc(doc(db, "Orders", orderId));
      alert('Order deleted');
      loadStats();
      loadAllOrders();
      loadRecentOrders();
    };

    // ------------------ MENU ITEMS ------------------
    async function loadMenuItems() {
      const menuSnap = await getDocs(collection(db, "Menuitems"));
      const tbody = document.getElementById('menu-items-body');
      tbody.innerHTML = '';
      menuSnap.forEach(docSnap => {
        const item = docSnap.data();
        tbody.innerHTML += `<tr>
          <td><img src="${item.imageurl || '../menu/meal1.jpg'}" style="width:50px;height:50px;object-fit:cover;border-radius:0.5rem;"></td>
          <td>${item.itemname}</td>
          <td>${item.category}</td>
          <td>KES ${item.price}</td>
          <td>${item.quantavailable}</td>
          <td>${item.isavailable ? '✓ Yes' : '✗ No'}</td>
          <td>
            <button class="btn btn-secondary btn-small" onclick="editMenuItem('${docSnap.id}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteMenuItem('${docSnap.id}')">Delete</button>
          </td>
        </tr>`;
      });
    }

    window.openMenuModal = () => {
      currentEditId = null;
      document.getElementById('modal-title').textContent = 'Add Menu Item';
      document.getElementById('item-name').value = '';
      document.getElementById('item-description').value = '';
      document.getElementById('item-category').value = 'Main Course';
      document.getElementById('item-price').value = '';
      document.getElementById('item-quantity').value = '';
      document.getElementById('item-available').checked = true;
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('menu-modal').classList.add('active');
    };

    window.closeMenuModal = () => document.getElementById('menu-modal').classList.remove('active');

    window.editMenuItem = async (itemId) => {
      currentEditId = itemId;
      const docSnap = await getDoc(doc(db, "Menuitems", itemId));
      const item = docSnap.data();
      document.getElementById('modal-title').textContent = 'Edit Menu Item';
      document.getElementById('item-name').value = item.itemname;
      document.getElementById('item-description').value = item.description;
      document.getElementById('item-category').value = item.category;
      document.getElementById('item-price').value = item.price;
      document.getElementById('item-quantity').value = item.quantavailable;
      document.getElementById('item-available').checked = item.isavailable;
      if (item.imageurl) {
        document.getElementById('image-preview').src = item.imageurl;
        document.getElementById('image-preview').style.display = 'block';
      }
      document.getElementById('menu-modal').classList.add('active');
    };

    function previewImage(input) {
      const preview = document.getElementById('image-preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.src = '';
        preview.style.display = 'none';
      }
    }

    // --- Cloudinary Upload ---
    async function uploadToCloudinary(file) {
      try {
        const url = "https://api.cloudinary.com/v1_1/douictwnx/image/upload";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "strathcart"); // unsigned preset
        formData.append("folder", "menu"); // optional folder

        const res = await fetch(url, { method: "POST", body: formData });
        if (!res.ok) throw new Error("Upload failed");

        const data = await res.json();
        return {
          url: data.secure_url,
          public_id: data.public_id,
          delete_token: data.delete_token || null
        };
      } catch (err) {
        console.error("Cloudinary upload error:", err);
        alert("Failed to upload image. Check console for details.");
        return { url: "", public_id: "", delete_token: "" };
      }
    }

    window.saveMenuItem = async () => {
      const name = document.getElementById('item-name').value.trim();
      const description = document.getElementById('item-description').value.trim();
      const category = document.getElementById('item-category').value;
      const price = parseFloat(document.getElementById('item-price').value);
      const quantity = parseInt(document.getElementById('item-quantity').value);
      const available = document.getElementById('item-available').checked;

      if (!name || !description || !price || !quantity)
        return alert('Please fill all fields');

      const imageFile = document.getElementById('item-image').files[0];
      let imageUrl = "", cloudinaryId = "", deleteToken = "";

      if (imageFile) {
        const uploaded = await uploadToCloudinary(imageFile);
        imageUrl = uploaded.url;
        cloudinaryId = uploaded.public_id;
        deleteToken = uploaded.delete_token;
      } else if (currentEditId) {
        const existingDoc = await getDoc(doc(db, "Menuitems", currentEditId));
        const existing = existingDoc.data();
        imageUrl = existing.imageurl || "";
        cloudinaryId = existing.cloudinary_id || "";
        deleteToken = existing.delete_token || "";
      }

      const itemData = { itemname: name, description, category, price, quantavailable: quantity, isavailable: available, imageurl: imageUrl, cloudinary_id: cloudinaryId, delete_token: deleteToken };

      try {
        if (currentEditId) {
          await updateDoc(doc(db, "Menuitems", currentEditId), itemData);
          alert("Menu item updated!");
        } else {
          await addDoc(collection(db, "Menuitems"), itemData);
          alert("Menu item added!");
        }
        closeMenuModal();
        loadMenuItems();
        loadStats();
      } catch (err) {
        console.error("Error saving menu item:", err);
        alert("Failed to save menu item.");
      }
    };

    window.deleteMenuItem = async (itemId) => {
      if (!confirm('Delete this menu item?')) return;
      await deleteDoc(doc(db, "Menuitems", itemId));
      alert('Menu item deleted');
      loadMenuItems();
      loadStats();
    };

    // ------------------ CREATE ADMIN ------------------
    window.createAdmin = async () => {
      const fullname = document.getElementById('admin-fullname').value.trim();
      const email = document.getElementById('admin-email').value.trim();
      const admission = document.getElementById('admin-admission').value.trim();
      const password = document.getElementById('admin-password').value;

      if (!fullname || !email || !admission || !password) return alert('Fill all fields');

      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "Users", userCred.user.uid), {
          fullName: fullname,
          email,
          admissionNumber: admission,
          role: 'admin'
        });
        alert('Admin created successfully!');
      } catch (err) {
        console.error("Error creating admin:", err);
        alert(err.message);
      }
    };

    window.logout = () => auth.signOut().then(() => window.location.href = 'adminlogin.html');

    // ------------------ TABS ------------------
    window.switchTab = (tabName) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    };
  </script>
</body>
</html>
